# IRN Generation and FIRS API Integration Documentation

## IRN Format Specification

The Invoice Reference Number (IRN) is a critical component of the FIRS e-Invoicing system. Each invoice must have a unique IRN that follows the FIRS-specified format.

### Components of an IRN

An IRN consists of three components concatenated with hyphens:

1. **Invoice Number**
   - Generated by the taxpayer's accounting system
   - Alphanumeric (combination of letters and numbers)
   - No special characters allowed (e.g., !, @, #, $, etc.)
   - Example formats: INV001, INV0001, INVOICE123, etc.

2. **Service ID**
   - A unique, system-generated identifier assigned to each taxpayer
   - Generated by: FIRS e-Invoicing System
   - Uniqueness: Unique to each taxpayer
   - Format: Alphanumeric (combination of letters and numbers)
   - Length: 8 characters
   - Example: 94ND90NR

3. **Timestamp**
   - The exact date of the invoice issuance
   - Format: YYYYMMDD (year, month, day)
   - Numeric only (no dashes, slashes, or special characters)
   - Example: 20250525

### Example IRN

```
INV001-94ND90NR-20250525
```

## IRN Validation

The IRN validation system implements comprehensive checks to ensure IRNs comply with FIRS requirements:

1. **Format Validation**
   - Pattern checking using regex: `^[a-zA-Z0-9]+-[a-zA-Z0-9]{8}-\d{8}$`
   - Component validation for each part of the IRN

2. **Component Validation**
   - Invoice Number: Must be alphanumeric without special characters
   - Service ID: Must be exactly 8 alphanumeric characters
   - Timestamp: Must be a valid date in YYYYMMDD format

## FIRS API Integration

### Authentication

All API requests require authentication using API keys in the headers:

```
x-api-key: {{API_KEY}}
x-api-secret: {{API_SECRET}}
```

Some endpoints also require user authentication via a JWT token.

### Base URLs

- **Sandbox Environment**: `https://eivc-k6z6d.ondigitalocean.app`
- **Production Environment**: *(To be provided by FIRS)*

### Key Endpoints

#### 1. Invoice Submission

**POST** `/api/v1/invoice`

Submit an invoice with automatic IRN generation

**Request:**
```json
{
  "business_id": "4a4d0d3b-2392-46d4-b3b4-8f9cc00d9443",
  "invoice_reference": "INV001",
  "invoice_date": "2025-05-25",
  "invoice_type_code": "380",
  "supplier": {
    "id": "4a4d0d3b-2392-46d4-b3b4-8f9cc00d9443",
    "tin": "31569955-0001",
    "name": "Your Company Ltd"
  },
  "customer": {
    "id": "171e2291-2656-44e4-a532-a49f31a61dbd",
    "tin": "98765432-0001",
    "name": "Sample Customer Ltd",
    "address": "456 Customer Street, Abuja",
    "email": "customer@example.com"
  },
  "invoice_items": [
    {
      "id": "ITEM001",
      "name": "Consulting Services",
      "quantity": 1,
      "unit_price": 50000.0,
      "total_amount": 50000.0,
      "vat_amount": 7500.0,
      "vat_rate": 7.5
    }
  ],
  "total_amount": 50000.0,
  "vat_amount": 7500.0,
  "currency_code": "NGN"
}
```

**Response:**
```json
{
  "code": 200,
  "data": {
    "irn": "INV001-94ND90NR-20250525",
    "submission_id": "5f3e9b1d-8c4e-4b0a-9f5d-8e7a3b1d4c2e",
    "status": "accepted"
  },
  "message": "Invoice successfully submitted"
}
```

#### 2. IRN Validation

**POST** `/api/v1/invoice/irn/validate`

Validate an IRN with FIRS

**Request:**
```json
{
  "business_id": "4a4d0d3b-2392-46d4-b3b4-8f9cc00d9443",
  "invoice_reference": "INV001",
  "irn": "INV001-94ND90NR-20250525",
  "invoice_date": "2025-05-25",
  "invoice_type_code": "380"
}
```

**Response:**
```json
{
  "code": 200,
  "data": {
    "irn": "INV001-94ND90NR-20250525",
    "status": "valid",
    "validation_date": "2025-05-25T14:22:53+01:00",
    "qr_code_url": "https://api.taxpoynt.com/qr/INV001-94ND90NR-20250525"
  },
  "message": "IRN validation successful"
}
```

## Odoo Integration

The TaxPoynt eInvoice system uses an ERP-first integration strategy, with robust support for Odoo.

### Features

- Automatically maps Odoo invoice fields to BIS Billing 3.0 UBL format
- Handles complex field transformations including tax calculations
- Generates compliant IRNs using the standard format
- Uses UUID4 format for business identification

### Key Endpoints

#### 1. Connect to Odoo

**POST** `/api/v1/odoo/connect`

Connect to an Odoo instance and fetch invoices

**Request:**
```json
{
  "url": "https://your-odoo-instance.com",
  "database": "your_odoo_database",
  "username": "your_odoo_username",
  "password": "your_odoo_password",
  "options": {
    "include_draft_invoices": false,
    "start_date": "2025-01-01",
    "limit": 50
  }
}
```

**Response:**
```json
{
  "code": 200,
  "data": {
    "connection_id": "9e8d7c6b-5a4b-3c2d-1e0f-9a8b7c6d5e4f",
    "invoices_count": 12,
    "invoice_ids": ["INV/2025/0001", "INV/2025/0002", "INV/2025/0003", "..."]
  },
  "message": "Successfully connected to Odoo instance"
}
```

#### 2. Submit Odoo Invoice

**POST** `/api/v1/odoo/submit`

Convert and submit an Odoo invoice to FIRS

**Request:**
```json
{
  "connection_id": "9e8d7c6b-5a4b-3c2d-1e0f-9a8b7c6d5e4f",
  "invoice_id": "INV/2025/0001",
  "business_id": "4a4d0d3b-2392-46d4-b3b4-8f9cc00d9443", 
  "use_sandbox": true
}
```

**Response:**
```json
{
  "code": 200,
  "data": {
    "irn": "INV/2025/0001-94ND90NR-20250525",
    "submission_id": "5f3e9b1d-8c4e-4b0a-9f5d-8e7a3b1d4c2e",
    "status": "accepted",
    "odoo_status_update": "success"
  },
  "message": "Odoo invoice successfully submitted to FIRS"
}
```

## IRN Testing Tools

The TaxPoynt eInvoice system includes comprehensive testing tools for IRN generation, validation, and API integration:

- Test IRN generation with various invoice numbers
- Validate IRN format and components
- Test API endpoints with sandbox mode
- Simulate Odoo invoice submissions
